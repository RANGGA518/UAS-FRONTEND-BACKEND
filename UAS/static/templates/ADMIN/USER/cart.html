<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Keranjang Belanja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        body {
            background: #f5f7fa;
        }
    
        /* === CHECKBOX === */
        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 3px solid #0d6efd;
            border-radius: 4px;
            cursor: pointer;
        }
    
        .custom-checkbox:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    
        .custom-checkbox:focus {
            box-shadow: none;
        }
    
        /* === CARD PRODUK === */
        .cart-item {
            transition: all .2s ease;
        }
    
        .cart-item.active {
            border: 2px solid #0d6efd;
            background: #eef4ff;
        }
    
        /* === SIDEBAR TOTAL === */
        .summary-box {
            position: sticky;
            top: 90px;
        }

    
        .product-link {
            font-size: 13px;
            font-weight: 500;
            color: #0d6efd;
            text-decoration: none;
        }

        .product-link:hover {
            text-decoration: underline;
            color: #0b5ed7;
        }
        
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
    <div class="container">

        <!-- BRAND -->
        <a class="navbar-brand fw-bold text-primary me-3" href="/">
            Minimarket
        </a>

        <!-- TOGGLER (MOBILE) -->
        <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarMain"
                aria-controls="navbarMain"
                aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- COLLAPSE AREA -->
        <div class="collapse navbar-collapse" id="navbarMain">

            <!-- SEARCH -->
            <div class="mx-lg-auto my-3 my-lg-0 w-100 d-flex justify-content-center position-relative">

                {% if pesan %}
                <div id="searchNotif" class="search-floating-alert">
                    <div class="alert alert-warning text-center shadow-sm mb-0">
                        {{ pesan }}
                    </div>
                </div>
                {% endif %}

                <form
                    action="{{ request.path }}"
                    method="get"
                    class="d-flex align-items-center search-wrapper w-100"
                    style="max-width:600px;"
                    onsubmit="return handleSearch(this)">

                    <input type="search"
                           name="q"
                           class="form-control search-input"
                           placeholder="Cari produk..."
                           value="{{ keyword or '' }}">

                    <button type="submit" class="btn btn-primary search-btn ms-2">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>

            <!-- RIGHT MENU -->
            <div class="d-flex align-items-center gap-3 ms-lg-4">

                <!-- CART -->
                <a href="/cart" class="position-relative text-decoration-none text-dark">
                    <i class="bi bi-cart3 fs-4"></i>
                    {% if cart_count > 0 %}
                    <span class="cart-badge">{{ cart_count }}</span>
                    {% endif %}
                </a>

                {% if session.get("user") %}
                <a href="/profile" class="user-profile d-flex align-items-center text-decoration-none text-dark">
                    <img src="{{ url_for('static', filename='img/user/images.png') }}" width="32" height="32" class="rounded-circle me-2">
                    <span class="fw-semibold">
                        Hi,&nbsp;{{ session.user }}
                    </span>
                </a>
                {% else %}
                <a href="/login" class="btn btn-outline-primary btn-sm">Masuk</a>
                <a href="/register" class="btn btn-primary btn-sm">Daftar</a>
                {% endif %}

            </div>

        </div>
    </div>
</nav>

<div class="container mt-5 mb-5">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold">Keranjang Belanja</h4>
    </div>

    {% if cart %}
    <div class="row">

        <!-- LIST PRODUK -->
        <div class="col-lg-8">

            <!-- PILIH SEMUA -->
            <div class="card mb-3">
                <div class="card-body d-flex align-items-center gap-2">
                    <input type="checkbox" id="checkAll" class="custom-checkbox">
                    <label for="checkAll" class="fw-semibold">
                        Pilih Semua Produk
                    </label>
                </div>
            </div>

            {% for kode, item in cart.items() %}
            <div class="card mb-3 cart-item" id="item-{{ kode }}">
                <div class="card-body d-flex align-items-center gap-3">

                    <input type="checkbox" 
                    class="custom-checkbox item-check" 
                    data-kode="{{ kode }}" 
                    data-harga="{{ item.harga }}">

                    <img src="{{ url_for('static', filename='img/produk/' ~ item.gambar) }}"
                         width="90" class="rounded">

                    <div class="flex-grow-1">
                        <h6 class="mb-1">{{ item.nama }}</h6>
                    
                        <!-- HARGA -->
                        <p class="fw-bold text-primary mb-1">
                            Rp {{ item.harga | rupiah }}
                        </p>
                    
                        <!-- QTY CONTROL -->
                        <div class="d-flex align-items-center gap-2">
                    
                            <button class="btn btn-outline-primary btn-sm qty-btn" onclick="updateQty('{{ kode }}', -1)">
                                −
                            </button>
                    
                            <span class="fw-semibold" id="qty-{{ kode }}">
                                {{ item.qty }}
                            </span>
                    
                            <button class="btn btn-outline-primary btn-sm qty-btn" onclick="updateQty('{{ kode }}', 1)">
                                +
                            </button>
                    
                        </div>
                    
                        <!-- LIHAT PRODUK -->
                        <a href="/product/{{ kode }}" class="text-primary small text-decoration-none d-inline-block mt-1">
                            Lihat produk
                        </a>
                    </div>

                    <button class="btn btn-sm btn-outline-danger" onclick="hapusItem('{{ kode }}')">
                        Hapus
                    </button>

                </div>
            </div>
            {% endfor %}
        </div>

        <!-- SUMMARY -->
        <div class="col-lg-4">
            <div class="card summary-box shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Ringkasan Belanja</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Harga</span>
                        <span class="fw-bold text-primary" id="totalHarga">
                            Rp 0
                        </span>
                    </div>

                    <button class="btn btn-primary w-100 mt-3">
                        Checkout
                    </button>
                </div>
            </div>
        </div>

    </div>
    {% else %}
    <div class="text-center mt-5">
        <h5 class="fw-semibold mb-3">
            Keranjang kamu masih kosong
        </h5>
        <a href="/" class="btn btn-primary">
            Mulai Belanja
        </a>
    </div>
    {% endif %}
</div>

<footer class="footer mt-5">
    <div class="container py-5">
        <div class="row g-4">

            <!-- BRAND -->
            <div class="col-lg-4 col-md-6">
                <h5 class="footer-brand">Minimarket</h5>
                <p class="footer-text">
                    Minimarket online untuk kebutuhan harian Anda.
                    Mudah, cepat, dan terpercaya.
                </p>

                <div class="footer-social">
                    <a href="#"><i class="bi bi-facebook"></i></a>
                    <a href="#"><i class="bi bi-instagram"></i></a>
                    <a href="#"><i class="bi bi-twitter-x"></i></a>
                </div>
            </div>

            <!-- MENU -->
            <div class="col-lg-2 col-md-6">
                <h6 class="footer-title">Menu</h6>
                <ul class="footer-links">
                    <li><a href="/">Beranda</a></li>
                    <li><a href="/cart">Keranjang</a></li>
                    <li><a href="/login">Masuk</a></li>
                    <li><a href="/register">Daftar</a></li>
                </ul>
            </div>

            <!-- KATEGORI -->
            <div class="col-lg-3 col-md-6">
                <h6 class="footer-title">Kategori Populer</h6>
                <ul class="footer-links">
                    <li><a href="#">Makanan</a></li>
                    <li><a href="#">Minuman</a></li>
                    <li><a href="#">Kebutuhan Rumah</a></li>
                    <li><a href="#">Produk Promo</a></li>
                </ul>
            </div>

            <!-- KONTAK -->
            <div class="col-lg-3 col-md-6">
                <h6 class="footer-title">Kontak Kami</h6>
                <ul class="footer-contact">
                    <li><i class="bi bi-geo-alt"></i> Indonesia</li>
                    <li><i class="bi bi-envelope"></i> support@minimarket.com</li>
                    <li><i class="bi bi-whatsapp"></i> 0812-3456-7890</li>
                </ul>
            </div>

        </div>
    </div>

    <!-- COPYRIGHT -->
    <div class="footer-bottom">
        <div class="container text-center">
            <small>© 2026 Minimarket. All rights reserved.</small>
        </div>
    </div>
</footer>

<!-- ================= JS ================= -->
<script>
    const notif = document.getElementById("searchNotif");

    if (notif) {
        setTimeout(() => {
            notif.style.opacity = "0";
            notif.style.transform = "translateY(-10px)";

            setTimeout(() => {
                notif.remove();
            }, 300);

        }, 3000);
    }

document.addEventListener("DOMContentLoaded", function () {

    const checkAll = document.getElementById("checkAll");
    const totalHargaEl = document.getElementById("totalHarga");

    function formatRupiah(n) {
        return "Rp " + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");
    }

    function hitungTotal() {
        let total = 0;

        document.querySelectorAll(".item-check").forEach(cb => {
            const kode = cb.dataset.kode;
            const card = cb.closest(".cart-item");

            if (cb.checked) {
                const harga = parseInt(cb.dataset.harga);
                const qty = parseInt(document.getElementById("qty-" + kode).innerText);
                total += harga * qty;
                card.classList.add("active");
            } else {
                card.classList.remove("active");
            }
        });

        totalHargaEl.innerText = formatRupiah(total);
    }

    /* PILIH SEMUA */
    if (checkAll) {
        checkAll.addEventListener("change", () => {
            document.querySelectorAll(".item-check")
                .forEach(cb => cb.checked = checkAll.checked);
            hitungTotal();
        });
    }

    /* CHECK ITEM */
    document.addEventListener("change", e => {
        if (e.target.classList.contains("item-check")) {
            const all = document.querySelectorAll(".item-check");
            const checked = document.querySelectorAll(".item-check:checked");
            checkAll.checked = all.length === checked.length;
            hitungTotal();
        }
    });

    /* UPDATE QTY */
    window.updateQty = function (kode, delta) {
        const qtyEl = document.getElementById("qty-" + kode);
        let qty = parseInt(qtyEl.innerText);

        if (qty + delta < 1) return;

        fetch("/cart/update", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ kode, delta })
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                qtyEl.innerText = res.qty;
                hitungTotal();
            }
        });
    }

    /* HAPUS */
    window.hapusItem = function (kode) {
        if (!confirm("Hapus produk?")) return;

        fetch("/cart/delete/" + kode, { method:"POST" })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                document.getElementById("item-" + kode).remove();
                hitungTotal();
            }
        });
    }

});
</script>

</body>
</html>

